<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bateria Suite</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <style>
    :root { --ink:#111827; --muted:#6b7280; --line:#e5e7eb; }
    *{ box-sizing:border-box }
    body{ font-family:Inter,system-ui; color:var(--ink); margin:0; }
    .top{ display:flex; gap:10px; padding:12px 16px; border-bottom:1px solid var(--line); align-items:center; }
    .brand{ font-weight:800; }
    .nav a{ margin-right:8px; text-decoration:none; color:#111; }
    .nav a.active{ font-weight:700; }
    .wrap{ padding:16px; }
    .card{ border:1px solid var(--line); border-radius:12px; padding:12px; }
    .btn{ padding:8px 12px; border-radius:12px; border:1px solid var(--line); background:#fff; cursor:pointer }
    .btn-dark{ background:#111; color:#fff; border-color:#111 }
    .btn-green{ background:#10b981; color:#fff; border-color:#10b981 }
    .grid-rit{ display:grid; grid-template-columns: repeat(4, 1fr); gap:12px }
    @media (max-width:1000px){ .grid-rit{ grid-template-columns: repeat(2, 1fr)} }
    @media (max-width:640px){ .grid-rit{ grid-template-columns: 1fr } }
    .badge{ border:1px solid var(--line); border-radius:10px; padding:2px 6px; font-size:12px }
    input, select, textarea{ width:100%; padding:10px; border:1px solid var(--line); border-radius:10px }
    table{ width:100%; border-collapse:collapse; font-size:14px }
    th, td{ border-bottom:1px solid var(--line); padding:8px; text-align:left }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // ===== Supabase Init =====
    const SUPABASE_URL = "https://eauzqljvfbleavkrzouq.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhdXpxbGp2ZmJsZWF2a3J6b3VxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNzQ1NTgsImV4cCI6MjA3MzY1MDU1OH0.iKyMJ3NUHwDBG4hhdrdHyrX-Of3IT_INuN3nBcocSpY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let CURRENT_UID = null;

    // ===== UI helpers =====
    const $ = (s, r=document) => r.querySelector(s);
    const el = (tag, cls='', html='') => { const x=document.createElement(tag); if(cls) x.className=cls; if(html) x.innerHTML=html; return x; };
    function topbar(active='dashboard'){
      const root = el('div','top');
      root.innerHTML = `<div class="brand">Bateria</div>
        <div class="nav">
          <a href="#dashboard" class="${active==='dashboard'?'active':''}">Dashboard</a>
          <a href="#ritmistas" class="${active==='ritmistas'?'active':''}">Ritmistas</a>
          <a href="#ensaios" class="${active==='ensaios'?'active':''}">Ensaios</a>
          <a href="#backup" class="${active==='backup'?'active':''}">Backup</a>
        </div>`;
      const userbox = el('div', '', `<span id="emailbox" style="margin-left:auto;color:#555;font-size:12px"></span>
        <button id="logout" class="btn" style="margin-left:8px">Sair</button>`);
      root.append(userbox);
      return root;
    }

    // ===== Auth gate (login + signup + reset) =====
    async function requireAuth() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        document.body.innerHTML = `... (mesmo login/signup que já te mandei) ...`;
        // (código omitido aqui só para não duplicar no chat, mas já está no arquivo completo que te enviei antes)
        throw new Error('no-auth');
      }
      CURRENT_UID = user.id;
      return user;
    }

    // ===== DAO (Supabase) =====
    // (listRitmistas, createRitmista, listEnsaios, presenças etc. — já corrigido, igual ao arquivo anterior)

    // ===== Pages =====
    function setHash(h){ location.hash = h; }
    function renderTop(active){
      const t = topbar(active);
      t.querySelector('#logout').onclick = async()=>{
        await supabase.auth.signOut();
        location.reload();
      };
      return t;
    }

    async function pageDashboard(){
      const app = $('#app'); app.innerHTML=''; app.append(renderTop('dashboard'));
      ...
    }
    async function pageRitmistas(){
      const app = $('#app'); app.innerHTML=''; app.append(renderTop('ritmistas'));
      ...
    }
    async function pageEnsaios(){
      const app = $('#app'); app.innerHTML=''; app.append(renderTop('ensaios'));
      ...
    }
    async function pageEnsaioDetail(id){
      const app = $('#app'); app.innerHTML=''; app.append(renderTop('ensaios'));
      ...
    }
    async function pageBackup(){
      const app = $('#app'); app.innerHTML=''; app.append(renderTop('backup'));
      ...
    }

    // ===== Router =====
    async function router(){
      const hash = (location.hash||'').replace('#','');
      if (hash.startsWith('ritmista:')) return pageRitmistaDetail(hash.split(':')[1]);
      if (hash.startsWith('ensaio:')) return pageEnsaioDetail(hash.split(':')[1]);
      if (hash==='ritmistas') return pageRitmistas();
      if (hash==='ensaios') return pageEnsaios();
      if (hash==='backup') return pageBackup();
      return pageDashboard();
    }
    window.addEventListener('hashchange', router);

    // Start after auth
    requireAuth().then(async (u)=>{
      document.body.innerHTML = '<div id="app"></div>';
      document.getElementById('app').append(topbar('dashboard'));
      document.getElementById('emailbox').textContent = u.email||'';
      router();
    }).catch(()=>{});
  </script>
</body>
</html>
